{% extends 'base.html' %}

{% load static %}
{% load crispy_forms_filters %}

{% block content %}
    <form id="sign-up-form" method="post">
        {% csrf_token %}
        {{ form|crispy }}
        <hr>
        <h6>Sintomas</h6>
        {{ symptom_formset.management_form }}
        <div id="symptoms">
            <div>{{ symptom_formset.forms.0|crispy }}</div>
        </div>
        <hr>
        <h6>Histórico de viagens</h6>
        {{ trip_formset.management_form }}
        <div id="trips">
            <div>{{ trip_formset.forms.0|crispy }}</div>
        </div>
        <hr>
        <h6>Outras doenças</h6>
        {{ comorbidity_formset.management_form }}
        <div id="comorbidities">
            <div>{{ comorbidity_formset.forms.0|crispy }}</div>
        </div>

        <div class="form-row">
            <div class="form-group col"><input type="submit" class="btn btn-primary align-right" value="Salvar"></div>
        </div>
    </form>

    <script src="{% static 'dynamic_formsets/jquery.formset.js' %}" type="text/javascript"></script>

    <script>
        function addressQuery(row, formCount) {
            const input = $(this);
            const maxlength = parseInt(input.attr('maxlength'));

            if (maxlength === input.val().length) {
                console.log("Consultando CEP...");
                var xhr = new XMLHttpRequest();
                xhr.open("GET", "http://cep.la/" + input.val(), true);
                xhr.setRequestHeader("Accept", "application/json");
                xhr.onreadystatechange = function () {
                    if ((xhr.readyState === 0 || xhr.readyState === 4) && xhr.status === 200) {
                        const response = JSON.parse(xhr.responseText);
                        console.log(xhr.responseText);
                        let prefix, id;

                        prefix = input.attr("id").split("-")[0];
                        id = input.attr("id").split("-")[1];

                        console.log(prefix, " ", id);

                        $(`#${prefix}-${id}-street_name`).val(response.logradouro);
                        $(`#${prefix}-${id}-neighbourhood`).val(response.bairro);
                        $(`#${prefix}-${id}-city`).val(response.cidade);
                    }
                };
                xhr.send(null);
            }
        }

        $.each([
            {
                selector: "#symptoms",
                prefix: "{{ symptom_formset.prefix }}",
                label: "Sintoma",
                template: $.parseHTML("{{ symptom_formset.empty_form|crispy|escapejs }}")
            },
            {
                selector: "#trips",
                prefix: "{{ trip_formset.prefix }}",
                label: "Viagens",
                template: $.parseHTML("{{ trip_formset.empty_form|crispy|escapejs }}")
            },
            {
                selector: "#comorbidities",
                prefix: "{{ comorbidity_formset.prefix }}",
                label: "Outras doenças",
                template: $.parseHTML("{{ comorbidity_formset.empty_form|crispy|escapejs }}")
            }
        ], function (i, d) {
            $(d.selector).formset({
                prefix: d.prefix,
                allowEmptyFormset: true,
                formCssClass: "dynamic-form-" + d.label[0],
                callbacks: {
                    onAdd: function (row, formCount) {
                        row = $(row);

                        row.find("h6").html(`${d.label} ${row.siblings().length + 1}`);
                    },
                    onRemove: function (row) {
                        $(".dynamic-form-" + d.label).each(function (i, formRow) {
                            $(formRow).find("h6").html(`${d.label} ${i + 1}`);
                        });
                    }
                },
                uiText: {
                    addPrompt: "Adicionar",
                    removePrompt: "Remover"
                }
            });
        });
    </script>
{% endblock %}